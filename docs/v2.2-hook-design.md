# Claudememv2 v2.2 Hook 触发设计（暂存）

本文档记录 v2.2 版本计划实现的 Claude Code Hook 自动触发功能。

## 概述

v2.2 将支持通过 Claude Code 的 Hook 系统自动保存会话，无需用户手动触发。

## Hook 配置

在 `~/.claude/settings.json` 中添加：

```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "command": "python ~/.claude/Claudememv2-data/scripts/auto-save.py"
          }
        ]
      }
    ]
  }
}
```

## 触发时机

### Stop Hook
- 当 Claude 完成响应时触发
- 适合保存完整对话

### PostToolUse Hook（备选）
- 每次工具调用后触发
- 可用于实时记录重要操作

## 配置选项

```json
{
  "hooks": {
    "autoSave": {
      "enabled": true,
      "trigger": "stop",           // "stop" | "interval" | "keyword"
      "minMessages": 5,            // 最少消息数才触发保存
      "keywords": ["重要", "记住"], // keyword 模式的触发词
      "silent": true               // 静默保存，不打断用户
    }
  }
}
```

## auto-save.py 脚本

```python
#!/usr/bin/env python3
"""
Claudememv2 Auto-Save Script
Triggered by Claude Code hooks
"""

import sys
import json
from pathlib import Path

# Add scripts directory to path
scripts_dir = Path(__file__).parent
sys.path.insert(0, str(scripts_dir))

from memory_core import load_config
from session_parser import SessionParser


def main():
    config = load_config()

    # Check if auto-save is enabled
    hook_config = config.get("hooks", {}).get("autoSave", {})
    if not hook_config.get("enabled", False):
        return

    # Check minimum messages
    min_messages = hook_config.get("minMessages", 5)

    parser = SessionParser(config)
    session_path = parser.find_current_session()

    if session_path is None:
        return

    messages = parser.parse_session_file(session_path)

    if len(messages) < min_messages:
        return

    # Save session silently
    try:
        result = parser.save_session()
        if not hook_config.get("silent", True):
            print(f"✓ Auto-saved to {result['file_path']}")
    except Exception:
        pass  # Silent failure


if __name__ == "__main__":
    main()
```

## 安装步骤（v2.2）

1. 运行 `/Claudememv2:setup` 时增加 Hook 配置选项
2. 用户选择是否启用自动保存
3. 自动写入 `~/.claude/settings.json`

## 注意事项

- Hook 脚本必须快速执行（<1秒）
- 避免在 Hook 中进行 API 调用（可能超时）
- 静默模式下不输出任何内容
- 错误时静默失败，不影响 Claude Code 正常运行

## 与 v2.1 的兼容性

- v2.2 Hook 功能为可选
- 用户可同时使用手动命令和自动保存
- 配置独立，互不影响
